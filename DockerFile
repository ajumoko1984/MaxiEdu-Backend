# # ============================
# # Stage 1: Base
# # ============================
# FROM node:20-slim AS base
# WORKDIR /usr/src/maxiedu
# COPY package*.json ./

# # ============================
# # Stage 2: Dependencies
# # ============================
# FROM base AS deps
# RUN npm install --legacy-peer-deps --include=optional

# # ============================
# # Stage 3: Build
# # ============================
# FROM deps AS build
# COPY . .
# RUN npm run build


# # ============================
# # Stage 5: Production
# # ============================
# FROM node:20-slim AS production
# WORKDIR /usr/src/maxiedu

# # Copy node_modules from deps
# COPY --from=deps /usr/src/maxiedu/node_modules ./node_modules

# # Copy build output from build stage
# COPY --from=build /usr/src/maxiedu/build ./build

# # Copy package.json for reference
# COPY package*.json ./

# # Expose production port
# EXPOSE 8004

# # Start the production server
# CMD ["npm", "start"]






# ============================
# Stage 1: Base
# ============================
FROM node:20-slim AS base
WORKDIR /usr/src/maxiedu
COPY package*.json ./

# ============================
# Stage 2: Dependencies
# ============================
FROM base AS deps

# Install system dependencies for tfjs-node and canvas
RUN apt-get update && apt-get install -y \
    python3 \
    make \
    g++ \
    libcairo2-dev \
    libpango1.0-dev \
    libjpeg-dev \
    libgif-dev \
    && rm -rf /var/lib/apt/lists/*

# Install npm dependencies
RUN npm install --legacy-peer-deps --include=optional

# ============================
# Stage 3: Build
# ============================
FROM deps AS build
COPY . .
RUN npm run build

# ============================
# Stage 4: Production
# ============================
FROM node:20-slim AS production
WORKDIR /usr/src/maxiedu

# Copy node_modules from deps
COPY --from=deps /usr/src/maxiedu/node_modules ./node_modules

# Copy build output from build stage
COPY --from=build /usr/src/maxiedu/build ./build

# Copy package.json for reference
COPY package*.json ./

# Expose production port
EXPOSE 8004

# Start the production server
CMD ["npm", "start"]
